name: DVC Pipeline (Preprocess + Train)

on:
  push:
    branches:
      - feature/dvc_storage
  pull_request:
    branches:
      - feature/dvc_storage

jobs:
  dvc_pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Installer les d√©pendances
        run: |
          sudo apt update
          sudo apt install -y python3-pip
          pip install dvc[gdrive] mlflow tensorflow opencv-python scikit-learn

      - name: Ajouter les identifiants Google Drive
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          if [ -z "$GDRIVE_CREDENTIALS" ]; then
            echo "ERREUR : La cl√© secr√®te GDRIVE_CREDENTIALS est vide !"
            exit 1
          fi
          mkdir -p ~/.config/dvc/
          echo "$GDRIVE_CREDENTIALS" > ~/.config/dvc/gdrive-credentials.json
          echo "Fichier de cl√© secr√®te ajout√©"

      - name: Configurer DVC Remote
        run: |
          dvc remote modify gdrive_remote gdrive_use_service_account true
          dvc remote modify gdrive_remote --local credentialpath ~/.config/dvc/gdrive-credentials.json
          echo "DVC Remote configur√©"

      - name: T√©l√©charger les donn√©es depuis DVC
        run: |
          dvc pull
          echo "Donn√©es r√©cup√©r√©es depuis le stockage distant"

      - name: Ex√©cuter le pipeline DVC
        run: |
          dvc repro
          echo "Pipeline DVC ex√©cut√© avec succ√®s"

      - name: Pousser les fichiers mis √† jour vers le stockage DVC
        run: |
          if [[ $(dvc status) == *"to be pushed"* ]]; then
            dvc push
            echo "Donn√©es et mod√®le envoy√©s vers le stockage distant"
          else
            echo "Aucun changement d√©tect√©, dvc push ignor√©"
          fi

      - name: Valider les changements dans Git (si DVC a mis √† jour des fichiers)
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git diff --cached --quiet || git commit -m "üîÑ Mise √† jour des fichiers DVC apr√®s ex√©cution du pipeline"
          git push origin feature/dvc_storage || echo "‚ÑπÔ∏è Pas de changement √† pousser"
